    {#- service worker registration ~#}
    <script>{% apply minify_js ~%}
      if ('serviceWorker' in navigator) {
        {%- if site.serviceworker.notification.enabled|default(false) ~%}
        // checks notification permission
        Notification.requestPermission(permission => {
          if (!('permission' in Notification)) {
            Notification.permission = permission;
          }
          return permission;
        })
        {%- endif ~%}
        {%- if site.serviceworker is defined and site.serviceworker.enabled ~%}
        // register service worker
        navigator.serviceWorker.register('{{ url(site.page("serviceworker"), {canonical: true}) }}', { scope: '/' }).then(function (registration) {
          {%- if site.debug|default(false) ~%}
          console.log('[SW] Registration successful with scope', registration.scope);
          {%- endif ~%}
        }).catch(function (err) {
          console.log('[SW]', err);
        });
        {%- endif ~%}
        {%- if site.serviceworker is defined and not site.serviceworker.enabled ~%}
        // if service worker is disabled:
        // 1. unregister
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            {%- if site.debug|default(false) ~%}
            console.log('[SW] Unregister');
            {%- endif ~%}
            registration.unregister()
          })
        })
        // 2. remove cache
        caches.keys().then(function(keyList) {
          Promise.all(keyList.map(function(key) {
            {%- if site.debug|default(false) ~%}
            console.log('[SW] Remove cache');
            {%- endif ~%}
            caches.delete(key);
          }));
        });
        {%- endif ~%}
      }
      {%- if site.serviceworker is defined and site.debug|default(false) ~%}
      // cache storage usage
      if ('webkitTemporaryStorage' in navigator && 'queryUsageAndQuota' in navigator.webkitTemporaryStorage) {
        navigator.webkitTemporaryStorage.queryUsageAndQuota(
          function (usedBytes, grantedBytes) {
            console.log('[SW] Cache size:', (usedBytes / 1048576).toFixed(2), '/', (grantedBytes / 1048576).toFixed(0), 'Mo');
          },
          function (e) { console.log('Error', e); }
        );
      };
      // offline?
      window.addEventListener('offline', function(){
        console.log('Oh no, you lost your network connection.');
      });
      {%- endif ~%}
    {% endapply %}</script>